# 核心轉換功能規格

## 功能概述

核心轉換引擎負責將 Markdown 文件解析並轉換為 Word（.docx）和 PDF 格式，完整保留格式，支援 Mermaid 圖表渲染和圖片處理。

## 功能需求

### 1. Markdown 解析

**支援語法**：
- ✅ **標題**：H1-H6（`#` 到 `######`）
- ✅ **段落**：自動換行、硬換行（兩個空格）
- ✅ **強調**：粗體（`**bold**`）、斜體（`*italic*`）、刪除線（`~~strike~~`）
- ✅ **列表**：有序、無序、巢狀列表、任務列表（`- [ ]`）
- ✅ **表格**：GFM 表格、對齊方式（左/中/右）
- ✅ **代碼**：行內代碼（`` `code` ``）、代碼塊（` ```language `）、語法高亮
- ✅ **引用**：單層與多層引用（`>` 和 `>>`）
- ✅ **連結**：行內連結、參考式連結、自動連結
- ✅ **圖片**：行內圖片、參考式圖片、alt 文字、title 屬性
- ✅ **水平線**：`---`、`***`、`___`
- ✅ **HTML 標籤**：基本 HTML 標籤（保留或轉換）

**錯誤處理**：
- 無效語法：發出警告（console/log），顯示行號，繼續處理
- 不支援的語法：顯示為純文字，記錄警告

### 2. Mermaid 圖表渲染

**支援圖表類型**：
- Flowchart（流程圖）
- Sequence Diagram（時序圖）
- Class Diagram（類別圖）
- State Diagram（狀態圖）
- Gantt Chart（甘特圖）
- Pie Chart（圓餅圖）
- ER Diagram（實體關聯圖）
- User Journey（使用者旅程圖）

**渲染規則**：
- **Word 輸出**：轉為 PNG 圖片（可配置 DPI，預設 300）
- **PDF 輸出**：轉為 SVG 向量圖（保持清晰度）
- **背景色**：可配置（預設白色）
- **縮放比例**：可配置（預設 2x）

**渲染引擎**：
- 使用 Puppeteer + mermaid.js
- 離線渲染（內嵌 Chromium）
- 快取機制：相同代碼重用圖片

**錯誤處理**：
- 渲染失敗：保留原始代碼塊，標記「[Mermaid 渲染失敗]」
- 語法錯誤：記錄錯誤訊息，提供修正建議
- 超時控制：單一圖表渲染 < 30 秒

### 3. 圖片處理

**路徑類型**：
- **相對路徑**：`![](./images/pic.png)` - 基於 Markdown 檔案位置解析
- **絕對路徑**：`![](/home/user/pic.png)` - 直接讀取
- **網路路徑**：`![](https://example.com/pic.png)` - 下載或保留連結

**處理策略**（可配置）：
1. **embed**（嵌入）：圖片 Base64 編碼嵌入文檔（預設）
2. **copy**（複製）：複製圖片到輸出目錄
3. **link**（連結）：保留原始連結（需要網路）
4. **ask**（詢問）：每次轉換時詢問使用者

**錯誤處理**：
- 檔案不存在：顯示灰色佔位符（300x200），文字說明「圖片未找到：{路徑}」
- 下載失敗：顯示佔位符，記錄錯誤
- 格式不支援：嘗試轉換或顯示佔位符

**圖片格式**：
- 支援：PNG、JPG、JPEG、GIF、WebP、SVG、BMP
- 自動轉換：WebP → PNG（Word 相容性）

### 4. Word 轉換器

**實作細節**：
- 使用 `docx` 庫（Node.js）
- 完整支援樣式：字體、顏色、大小、間距、對齊

**格式對應**：
- 標題 H1-H6 → Word 標題樣式 1-6
- 粗體/斜體 → 文字格式
- 列表 → Word 列表（保留巢狀結構）
- 表格 → Word 表格（支援合併儲存格、邊框樣式）
- 代碼塊 → 等寬字體 + 灰色背景
- 引用 → 縮排 + 左側邊框

**額外功能**：
- 自動生成目錄（可選）
- 頁首頁尾（可透過主題配置）
- 頁碼（可選）

### 5. PDF 轉換器

**實作細節**：
- 使用 Puppeteer（HTML → PDF）
- CSS 樣式完全可控

**格式對應**：
- Markdown → HTML（使用 marked）
- HTML → PDF（Puppeteer）
- CSS 樣式由主題檔案定義

**額外功能**：
- 分頁控制（page-break-before/after）
- 頁首頁尾
- 浮水印（可選）
- 超連結保留（可點擊）

**PDF 選項**：
- 紙張大小：A4（預設）、Letter、Legal
- 邊距：可配置
- 方向：直向（預設）、橫向

## 非功能需求

### 效能要求

- **小檔案（<10KB）**：< 1 秒
- **中型檔案（100KB）**：< 3 秒
- **大型檔案（1MB）**：< 10 秒
- **記憶體使用**：峰值 < 500MB

### 可靠性要求

- **格式保真度**：> 95%
- **Mermaid 渲染成功率**：> 98%
- **錯誤恢復**：所有錯誤不中斷轉換流程

### 相容性要求

- **Word 版本**：Office 2016+、Office 365、LibreOffice 7.x
- **PDF 閱讀器**：Adobe Reader、Preview（macOS）、Chrome、Firefox

## 驗收標準

- [ ] 支援所有列出的 Markdown 語法，手動測試通過
- [ ] Mermaid 8 種圖表類型全部渲染成功
- [ ] 圖片處理 4 種策略（embed/copy/link/ask）正常運作
- [ ] Word 輸出可在 Office 2016+ 開啟，格式正確
- [ ] PDF 輸出可在主流閱讀器顯示，超連結可點擊
- [ ] 無效 Markdown 語法發出警告，不中斷流程
- [ ] Mermaid 渲染失敗時保留原始代碼
- [ ] 圖片失效時顯示佔位符
- [ ] 效能測試達標（1MB < 10 秒）

## 相依性

- **解析**：marked 或 markdown-it
- **Word 生成**：docx
- **PDF 生成**：puppeteer-core
- **Mermaid**：mermaid + puppeteer
- **圖片處理**：sharp

## 測試策略

- **單元測試**：每個模組獨立測試（parser、mermaid-renderer、image-handler）
- **整合測試**：完整的 Markdown → Word/PDF 流程
- **快照測試**：比對生成的檔案與預期結果
- **效能測試**：基準測試（benchmark）

---

**規格版本**：1.0  
**最後更新**：2025-11-12
